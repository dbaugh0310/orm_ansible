---
- name: Create flask user
  ansible.builtin.user:
    name: "{{ flask_user }}"

- name: Git checkout
  ansible.builtin.git:
    repo: "{{ git_repo }}"
    dest: "{{ flask_root }}"
    version: "{{ git_repo_branch }}"
    force: True
  become: True
  become_user: "{{ flask_user }}" 
  register: git_pull
  notify: Reload gunicorn

- name: Include encrypted secrets
  ansible.builtin.include_vars: secrets.yml

- name: Create .env file from template
  ansible.builtin.template:
    src: .env.j2
    dest: "{{ flask_root }}/.env"
    mode: '0600'  # Strict permissions for secret files
  notify: Reload gunicorn
  no_log: true

- name: Create static directory
  ansible.builtin.file:
    path: "{{ flask_static_path }}/static"
    state: directory

- name: Download static files
  ansible.builtin.get_url:
    url: "{{ flask_static_source }}"
    dest: "{{ flask_static_path }}"
  register: download_result

- name: Unarchive static files
  ansible.builtin.unarchive:
    src: "{{ flask_static_path }}"
    dest: "{{ flask_static_path }}/static"
  when: download_result.changed

- name: Setup venv and install pips
  ansible.builtin.pip:
    requirements: "{{ flask_root }}/requirements.txt"
    virtualenv: "{{ flask_root }}/venv"
    virtualenv_command: "{{ flask_virteualenv_command }}"
  become: true
  become_user: "{{ flask_user }}" 

- name: Install additional pips
  ansible.builtin.pip:
    name: "{{ flask_pips }}"
    virtualenv: "{{ flask_root }}/venv"
    virtualenv_command: "{{ flask_virteualenv_command }}"